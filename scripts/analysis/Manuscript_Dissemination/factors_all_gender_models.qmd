---
title: "factor all gender models"
format: docx
date: today
editor: visual
execute:
  enabled: true
df-print: kable
project: 
  execute-dir: project
---


# Linear Regression: All Gender (Main Analyses)

## Model 1: FA \~ Factor 1 + Age

## Model 2: FA \~ Factor 1 + Age + IQ + SUS

Load Data

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(knitr)
library(broom)
library(gt)
library(dplyr)
library(stringr)
library(purrr)
library(tidyr)

```

```{r}

roi_fa_allgender <-  read_csv(here("data", "raw", "rawdata_manuscript_FA.csv")) |>
  rename(
    age  = Age...6,
    factor1 = `Factor 1.y`,
    factor2 = `Factor 2.y`,
    iq   = IQ.x,
    sus  = `Total Drug Use`
  ) |>
  filter(
    !is.na(FA_mean)
  )
```

Number of Participants

```{r}
n_distinct(roi_fa_allgender$subject_id)
```

## Model 1: FA \~ Factor 1 + Age

```{r}
models_fa_m1_allgender <- roi_fa_allgender |>
  group_by(roi) |>
  group_map(
    ~ lm(FA_mean ~ factor1 + age + Gender, data = .x),
    .keep = TRUE
  )

#effect size calculations for model
f2_pred_by_roi <- roi_fa_allgender |>
  group_by(roi) |>
  group_modify(\(.x, .y) {

    full <- lm(FA_mean ~ factor1 + age, data = .x)
    R2_full <- summary(full)$r.squared

    preds <- c("factor1", "age")

    f2s <- map_dbl(preds, \(p) {
      reduced <- update(full, paste(". ~ . -", p))
      R2_red <- summary(reduced)$r.squared
      (R2_full - R2_red) / (1 - R2_full)
    })

    tibble(term = preds, f2 = f2s)
  }) |>
  ungroup()


roi_names_all <- roi_fa_allgender |>
  distinct(roi) |>
  pull(roi)

names(models_fa_m1_allgender) <- roi_names_all

results_fa_m1_allgender <- map_dfr(
  names(models_fa_m1_allgender),
  ~ tidy(models_fa_m1_allgender[[.x]]) |>
    mutate(
      roi   = .x,
      model = "Model 1 (All Gender Main Analyses)"
    )
)

results_fa_m1_allgender_factor1 <- results_fa_m1_allgender |>
  filter(term == "factor1") |>
  mutate(p_fdr = p.adjust(p.value, method = "fdr"))

```

Simple Output (Just Factor 1 Effects)
```{r}
#| execute:
#|   cache: false
results_fa_m1_allgender_factor1 |>
  select(
    roi,
    estimate,
    std.error,
    statistic,
    p.value,
    p_fdr
  ) |>
  arrange(p_fdr)
```

Full Regression Output 
```{r}
#| execute:
#|   cache: false
results_apa <- results_fa_m1_allgender |>
  left_join(f2_pred_by_roi, by = c("term", "roi")) |>
  mutate(
    estimate  = round(estimate, 5),
    statistic = round(statistic, 2),
    p.value   = round(p.value, 3),
    sig = case_when(
      p.value < .001 ~ "***",
      p.value < .01  ~ "**",
      p.value < .05  ~ "*",
      TRUE           ~ ""
    ),
    estimate = paste0(estimate, sig)
  ) |>
  select(
    term,
    estimate,
    statistic,
    p.value,
    roi,
    model,
    f2
  )

results_apa |>
  gt() |>
  tab_header(
    title = md("**Table X**"),
    subtitle = md("*Linear regression predicting FA (Model 1)*")
  ) |>
  cols_label(
    term      = "Predictor",
    estimate  = html("Estimate (<i>&beta;</i>)"),
    statistic = "t",
    p.value   = html("<i>p</i>"),
    f2 = html("Cohen’s <i>f</i><sup>2</sup>"),
    roi       = "ROI",
    model     = "Model"
  ) |>
  fmt_number(
    columns = c(statistic, p.value),
    decimals = 3
  ) |>
  tab_source_note(
    source_note = md(
      "*Note.* FA = fractional anisotropy. Estimates are standardized regression coefficients. \
      *p* < .05*, **p* < .01**, ***p* < .001."
    )
  ) |>
  tab_options(
    table.border.top.style = "solid",
    table.border.bottom.style = "solid",
    column_labels.border.top.style = "solid",
    column_labels.border.bottom.style = "solid",
    table_body.border.bottom.style = "solid",
    table.border.left.style = "none",
    table.border.right.style = "none",
    heading.border.bottom.style = "none",
    column_labels.font.weight = "bold",
    table.font.size = 11,
    data_row.padding = px(4)
  )
```

## Model 2: FA \~ Factor 1 + Age + IQ + SUS

```{r}
roi_fa_model2_allgender <- roi_fa_allgender |>
  group_by(roi) |>
  group_map(
    ~ lm(FA_mean ~ factor1 + age + iq + sus, data = .x),
    .keep = TRUE
  )

#effect size calculations for model
f2_pred_by_roi_m2 <- roi_fa_allgender |>
  group_by(roi) |>
  group_modify(\(.x, .y) {

    full <- lm(FA_mean ~ factor1 + age + iq + sus, data = .x)
    R2_full <- summary(full)$r.squared

    preds <- c("factor1", "age", "iq", "sus")

    f2s <- map_dbl(preds, \(p) {
      reduced <- update(full, paste(". ~ . -", p))
      R2_red <- summary(reduced)$r.squared
      (R2_full - R2_red) / (1 - R2_full)
    })

    tibble(term = preds, f2 = f2s)
  }) |>
  ungroup()


names(roi_fa_model2_allgender) <- roi_names_all

results_roi_fa_model2_allgender <- map_dfr(
  names(roi_fa_model2_allgender),
  ~ tidy(roi_fa_model2_allgender[[.x]]) |>
    mutate(
      roi = .x,
      model = "Model 2 (All Gender: +IQ +SUS)"
    )
)


results_roi_fa_model2_factor1_allgender <- results_roi_fa_model2_allgender |>
  filter(term == "factor1") |>
  mutate(p_fdr = p.adjust(p.value, method = "fdr"))

```

Simple Output (Just Factor 1 Effects)

```{r}
#| execute:
#|   cache: false
results_roi_fa_model2_factor1_allgender |>
  select(
    roi,
    estimate,
    std.error,
    statistic,
    p.value,
    p_fdr
  ) |>
  arrange(p_fdr)
```

Full Regression Output

```{r}
#| execute:
#|   cache: false




results_apa <- results_roi_fa_model2_allgender |>
  left_join(f2_pred_by_roi_m2, by = c("term", "roi")) |>
  mutate(
    estimate  = round(estimate, 3),
    statistic = round(statistic, 2),
    p.value   = round(p.value, 3),
    sig = case_when(
      p.value < .001 ~ "***",
      p.value < .01  ~ "**",
      p.value < .05  ~ "*",
      TRUE           ~ ""
    ),
    estimate = paste0(estimate, sig)
  ) |>
  select(
    term,
    estimate,
    statistic,
    p.value,
    roi,
    model,
    f2
  )

results_apa |>
  gt() |>
  tab_header(
    title = md("**Table X**"),
    subtitle = md("*Hierarchical regression predicting FA (Model 2)*")
  ) |>
  cols_label(
    term      = "Predictor",
    estimate  = html("Estimate (<i>&beta;</i>)"),
    statistic = "t",
    p.value   = html("<i>p</i>"),
    f2 = html("Cohen’s <i>f</i><sup>2</sup>"),
    roi       = "ROI",
    model     = "Model"
  ) |>
  fmt_number(
    columns = c(statistic, p.value),
    decimals = 3
  ) |>
  tab_source_note(
    source_note = md(
      "*Note.* FA = fractional anisotropy. Estimates are standardized regression coefficients. \
      *p* < .05*, **p* < .01**, ***p* < .001."
    )
  ) |>
  tab_options(
    table.border.top.style = "solid",
    table.border.bottom.style = "solid",
    column_labels.border.top.style = "solid",
    column_labels.border.bottom.style = "solid",
    table_body.border.bottom.style = "solid",
    table.border.left.style = "none",
    table.border.right.style = "none",
    heading.border.bottom.style = "none",
    column_labels.font.weight = "bold",
    table.font.size = 11,
    data_row.padding = px(4)
  )


```

###Factor 2 Models


## Model 1: FA \~ Factor 2 + Age

```{r}
models_fa_m1_allgender <- roi_fa_allgender |>
  group_by(roi) |>
  group_map(
    ~ lm(FA_mean ~ factor2 + age, data = .x),
    .keep = TRUE
  )

#effect size calculations for model
f2_pred_by_roi <- roi_fa_allgender |>
  group_by(roi) |>
  group_modify(\(.x, .y) {

    full <- lm(FA_mean ~ factor2 + age, data = .x)
    R2_full <- summary(full)$r.squared

    preds <- c("factor2", "age")

    f2s <- map_dbl(preds, \(p) {
      reduced <- update(full, paste(". ~ . -", p))
      R2_red <- summary(reduced)$r.squared
      (R2_full - R2_red) / (1 - R2_full)
    })

    tibble(term = preds, f2 = f2s)
  }) |>
  ungroup()


roi_names_all <- roi_fa_allgender |>
  distinct(roi) |>
  pull(roi)

names(models_fa_m1_allgender) <- roi_names_all

results_fa_m1_allgender <- map_dfr(
  names(models_fa_m1_allgender),
  ~ tidy(models_fa_m1_allgender[[.x]]) |>
    mutate(
      roi   = .x,
      model = "Model 1 (All Gender Main Analyses)"
    )
)

results_fa_m1_allgender_factor2 <- results_fa_m1_allgender |>
  filter(term == "factor2") |>
  mutate(p_fdr = p.adjust(p.value, method = "fdr"))

```

Simple Output (Just Factor 2 Effects)
```{r}
#| execute:
#|   cache: false
results_fa_m1_allgender_factor2 |>
  select(
    roi,
    estimate,
    std.error,
    statistic,
    p.value,
    p_fdr
  ) |>
  arrange(p_fdr)
```

Full Regression Output 
```{r}
#| execute:
#|   cache: false
results_apa <- results_fa_m1_allgender |>
  left_join(f2_pred_by_roi, by = c("term", "roi")) |>
  mutate(
    estimate  = round(estimate, 5),
    statistic = round(statistic, 2),
    p.value   = round(p.value, 3),
    sig = case_when(
      p.value < .001 ~ "***",
      p.value < .01  ~ "**",
      p.value < .05  ~ "*",
      TRUE           ~ ""
    ),
    estimate = paste0(estimate, sig)
  ) |>
  select(
    term,
    estimate,
    statistic,
    p.value,
    roi,
    model,
    f2
  )

results_apa |>
  gt() |>
  tab_header(
    title = md("**Table X**"),
    subtitle = md("*Linear regression predicting FA (Model 1)*")
  ) |>
  cols_label(
    term      = "Predictor",
    estimate  = html("Estimate (<i>&beta;</i>)"),
    statistic = "t",
    p.value   = html("<i>p</i>"),
    f2 = html("Cohen’s <i>f</i><sup>2</sup>"),
    roi       = "ROI",
    model     = "Model"
  ) |>
  fmt_number(
    columns = c(statistic, p.value),
    decimals = 3
  ) |>
  tab_source_note(
    source_note = md(
      "*Note.* FA = fractional anisotropy. Estimates are standardized regression coefficients. \
      *p* < .05*, **p* < .01**, ***p* < .001."
    )
  ) |>
  tab_options(
    table.border.top.style = "solid",
    table.border.bottom.style = "solid",
    column_labels.border.top.style = "solid",
    column_labels.border.bottom.style = "solid",
    table_body.border.bottom.style = "solid",
    table.border.left.style = "none",
    table.border.right.style = "none",
    heading.border.bottom.style = "none",
    column_labels.font.weight = "bold",
    table.font.size = 11,
    data_row.padding = px(4)
  )
```

## Model 2: FA \~ Factor 2 + Age + IQ + SUS

```{r}
roi_fa_model2_allgender <- roi_fa_allgender |>
  group_by(roi) |>
  group_map(
    ~ lm(FA_mean ~ factor2 + age + iq + sus, data = .x),
    .keep = TRUE
  )

#effect size calculations for model
f2_pred_by_roi_m2 <- roi_fa_allgender |>
  group_by(roi) |>
  group_modify(\(.x, .y) {

    full <- lm(FA_mean ~ factor2 + age + iq + sus, data = .x)
    R2_full <- summary(full)$r.squared

    preds <- c("factor2", "age", "iq", "sus")

    f2s <- map_dbl(preds, \(p) {
      reduced <- update(full, paste(". ~ . -", p))
      R2_red <- summary(reduced)$r.squared
      (R2_full - R2_red) / (1 - R2_full)
    })

    tibble(term = preds, f2 = f2s)
  }) |>
  ungroup()


names(roi_fa_model2_allgender) <- roi_names_all

results_roi_fa_model2_allgender <- map_dfr(
  names(roi_fa_model2_allgender),
  ~ tidy(roi_fa_model2_allgender[[.x]]) |>
    mutate(
      roi = .x,
      model = "Model 2 (All Gender: +IQ +SUS)"
    )
)


results_roi_fa_model2_factor2_allgender <- results_roi_fa_model2_allgender |>
  filter(term == "factor2") |>
  mutate(p_fdr = p.adjust(p.value, method = "fdr"))

```

Simple Output (Just Factor 2 Effects)

```{r}
#| execute:
#|   cache: false
results_roi_fa_model2_factor2_allgender |>
  select(
    roi,
    estimate,
    std.error,
    statistic,
    p.value,
    p_fdr
  ) |>
  arrange(p_fdr)
```

Full Regression Output

```{r}
#| execute:
#|   cache: false




results_apa <- results_roi_fa_model2_allgender |>
  left_join(f2_pred_by_roi_m2, by = c("term", "roi")) |>
  mutate(
    estimate  = round(estimate, 3),
    statistic = round(statistic, 2),
    p.value   = round(p.value, 3),
    sig = case_when(
      p.value < .001 ~ "***",
      p.value < .01  ~ "**",
      p.value < .05  ~ "*",
      TRUE           ~ ""
    ),
    estimate = paste0(estimate, sig)
  ) |>
  select(
    term,
    estimate,
    statistic,
    p.value,
    roi,
    model,
    f2
  )

results_apa |>
  gt() |>
  tab_header(
    title = md("**Table X**"),
    subtitle = md("*Hierarchical regression predicting FA (Model 2)*")
  ) |>
  cols_label(
    term      = "Predictor",
    estimate  = html("Estimate (<i>&beta;</i>)"),
    statistic = "t",
    p.value   = html("<i>p</i>"),
    f2 = html("Cohen’s <i>f</i><sup>2</sup>"),
    roi       = "ROI",
    model     = "Model"
  ) |>
  fmt_number(
    columns = c(statistic, p.value),
    decimals = 3
  ) |>
  tab_source_note(
    source_note = md(
      "*Note.* FA = fractional anisotropy. Estimates are standardized regression coefficients. \
      *p* < .05*, **p* < .01**, ***p* < .001."
    )
  ) |>
  tab_options(
    table.border.top.style = "solid",
    table.border.bottom.style = "solid",
    column_labels.border.top.style = "solid",
    column_labels.border.bottom.style = "solid",
    table_body.border.bottom.style = "solid",
    table.border.left.style = "none",
    table.border.right.style = "none",
    heading.border.bottom.style = "none",
    column_labels.font.weight = "bold",
    table.font.size = 11,
    data_row.padding = px(4)
  )


```